<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Espace Professionnel — Sika-Santé</title>
    <meta name="description" content="Interface médicale professionnelle">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <link href="assets/vendors/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendors/bootstrap-icons/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">

    <style>
      :root {
        --sidebar-width: 280px;
        --header-height: 70px;
      }

      @keyframes slideInRight {
        from { transform: translateX(120%); opacity: 0; }
        to   { transform: translateX(0);    opacity: 1; }
      }

      body {
        overflow-x: hidden;
        background: #f8f9fa;
      }

      /* Header */
      .pro-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background: white;
        border-bottom: 2px solid var(--bs-primary);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }

      .pro-header .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .pro-header .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--bs-primary), var(--bs-secondary));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
      }

      .role-badge {
        background: rgba(var(--bs-primary-rgb), 0.1);
        color: var(--bs-primary);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .scan-btn {
        background: var(--bs-primary);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .scan-btn:hover {
        background: var(--bs-primary-hover);
      }

      /* Sidebar */
      .sidebar {
        position: fixed;
        top: var(--header-height);
        left: 0;
        width: var(--sidebar-width);
        height: calc(100vh - var(--header-height));
        background: white;
        border-right: 1px solid rgba(var(--inverse-color-rgb), 0.1);
        overflow-y: auto;
        z-index: 999;
        transition: transform 0.3s ease;
      }

      .sidebar.hidden {
        transform: translateX(-100%);
      }

      .sidebar-menu {
        list-style: none;
        padding: 20px 0;
        margin: 0;
      }

      .sidebar-menu li a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 20px;
        color: var(--bs-body-color);
        text-decoration: none;
        transition: all 0.2s;
        font-weight: 500;
      }

      .sidebar-menu li a:hover,
      .sidebar-menu li a.active {
        background: rgba(var(--bs-primary-rgb), 0.1);
        color: var(--bs-primary);
        border-left: 3px solid var(--bs-primary);
      }

      .sidebar-menu li a i {
        font-size: 22px;
        width: 28px;
      }

      /* Main Content */
      .main-content {
        margin-left: var(--sidebar-width);
        margin-top: var(--header-height);
        padding: 30px;
        min-height: calc(100vh - var(--header-height));
      }

      @media (max-width: 991px) {
        .sidebar {
          transform: translateX(-100%);
        }
        .sidebar.show {
          transform: translateX(0);
        }
        .main-content {
          margin-left: 0;
        }
      }

      /* Status Bar */
      .status-bar {
        position: fixed;
        bottom: 0;
        left: var(--sidebar-width);
        right: 0;
        height: 35px;
        background: #2c3e50;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 20px;
        font-size: 12px;
        z-index: 998;
      }

      @media (max-width: 991px) {
        .status-bar {
          left: 0;
        }
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-indicator.online {
        background: #2ecc71;
      }

      .status-indicator.offline {
        background: #e74c3c;
      }

      /* Cards */
      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        border-left: 4px solid var(--bs-primary);
        transition: all 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(var(--bs-black-rgb), 0.1);
      }

      .stat-card .number {
        font-size: 36px;
        font-weight: 700;
        color: var(--bs-primary);
        margin-bottom: 5px;
      }

      .stat-card .label {
        color: var(--bs-body-color);
        font-size: 14px;
      }

      .quick-action-pro {
        background: white;
        border: 2px solid var(--bs-primary);
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        height: 100%;
      }

      .quick-action-pro:hover {
        background: var(--bs-primary);
        color: white;
        transform: scale(1.05);
      }

      .quick-action-pro i {
        font-size: 48px;
        margin-bottom: 15px;
        color: var(--bs-primary);
      }

      .quick-action-pro:hover i {
        color: white;
      }

      .alert-critical {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .alert-critical.danger {
        background: #f8d7da;
        border-left-color: #dc3545;
      }

      .section-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border: 1px solid rgba(var(--inverse-color-rgb), 0.1);
      }

      .section-card h4 {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--bs-primary);
      }

      .patient-card {
        background: white;
        border: 1px solid rgba(var(--inverse-color-rgb), 0.1);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .patient-card:hover {
        box-shadow: 0 5px 20px rgba(var(--bs-black-rgb), 0.1);
        border-color: var(--bs-primary);
      }

      .vital-info-emergency {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
      }

      .vital-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .vital-item {
        background: rgba(255, 255, 255, 0.15);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
      }

      .vital-item label {
        font-size: 12px;
        opacity: 0.9;
        display: block;
        margin-bottom: 5px;
      }

      .vital-item strong {
        font-size: 20px;
        display: block;
      }

      .tab-nav {
        display: flex;
        gap: 10px;
        border-bottom: 2px solid rgba(var(--inverse-color-rgb), 0.1);
        margin-bottom: 20px;
      }

      .tab-nav button {
        padding: 12px 24px;
        background: none;
        border: none;
        color: var(--bs-body-color);
        font-weight: 500;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
      }

      .tab-nav button:hover,
      .tab-nav button.active {
        color: var(--bs-primary);
        border-bottom-color: var(--bs-primary);
      }

      .page-section {
        display: none;
      }

      .page-section.active {
        display: block;
      }

      .permission-disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      .qr-scanner-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
      }

      .qr-scanner-modal.show {
        display: flex;
      }

      .qr-scanner-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
      }
    </style>

    <script>
  const TOKEN_KEY = 'sika_access_token';
  const ROLE_KEY = 'sika_user_role';
  const USER_KEY = 'sika_user_data';
  const PERMISSIONS_KEY = 'sika_user_permissions';
  const PATIENT_REGISTRY_KEY = 'sika_patient_registry_v1';
  const PROFESSIONAL_AUDIT_KEY = 'sika_professional_audit_v1';

  let currentUser = {};
  let currentPatient = null;
  let patientRegistry = [];

  function safeParse(value, fallback) {
    try { return JSON.parse(value); } catch (_) { return fallback; }
  }

  // ── Utilitaires UI : toast, confirm, prompt (sans alert/confirm/prompt natifs) ──

  function showToast(message, type = 'success') {
    const colors = { success: '#2ecc71', danger: '#e74c3c', warning: '#f39c12', info: '#3498db' };
    const icons  = { success: 'check-circle-fill', danger: 'x-circle-fill', warning: 'exclamation-triangle-fill', info: 'info-circle-fill' };
    const toast = document.createElement('div');
    toast.style.cssText = `
      position:fixed;top:80px;right:20px;z-index:9999;
      background:#fff;border-left:4px solid ${colors[type] || colors.info};
      border-radius:8px;padding:14px 18px;min-width:280px;max-width:380px;
      box-shadow:0 4px 20px rgba(0,0,0,0.15);display:flex;align-items:center;gap:12px;
      animation:slideInRight .3s ease;
    `;
    toast.innerHTML = `
      <i class="bi bi-${icons[type] || icons.info}" style="font-size:20px;color:${colors[type]};flex-shrink:0;"></i>
      <span style="font-size:14px;color:#333;flex:1;">${message}</span>
      <button onclick="this.parentElement.remove()" style="background:none;border:none;font-size:18px;color:#999;cursor:pointer;padding:0;line-height:1;">&times;</button>
    `;
    document.body.appendChild(toast);
    setTimeout(() => { if (toast.parentElement) toast.remove(); }, 4000);
  }

  function uiConfirm(message, onConfirm, { title = 'Confirmation', confirmLabel = 'Confirmer', confirmClass = 'btn-primary', cancelLabel = 'Annuler' } = {}) {
    const id = `confirm-${Date.now()}`;
    const backdrop = document.createElement('div');
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;display:flex;align-items:center;justify-content:center;';
    backdrop.innerHTML = `
      <div style="background:#fff;border-radius:16px;padding:28px 32px;max-width:420px;width:90%;box-shadow:0 8px 40px rgba(0,0,0,.2);">
        <h5 style="margin:0 0 12px;font-weight:700;">${title}</h5>
        <p style="margin:0 0 24px;color:#555;font-size:14px;">${message}</p>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button id="${id}-cancel" class="btn btn-outline-secondary btn-sm">${cancelLabel}</button>
          <button id="${id}-ok" class="btn ${confirmClass} btn-sm">${confirmLabel}</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    document.getElementById(`${id}-cancel`).onclick = () => backdrop.remove();
    document.getElementById(`${id}-ok`).onclick = () => { backdrop.remove(); onConfirm(); };
  }

  function uiPrompt(label, defaultValue, onSubmit, { title = 'Saisie' } = {}) {
    const id = `prompt-${Date.now()}`;
    const backdrop = document.createElement('div');
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;display:flex;align-items:center;justify-content:center;';
    backdrop.innerHTML = `
      <div style="background:#fff;border-radius:16px;padding:28px 32px;max-width:440px;width:90%;box-shadow:0 8px 40px rgba(0,0,0,.2);">
        <h5 style="margin:0 0 16px;font-weight:700;">${title}</h5>
        <label style="font-size:13px;font-weight:600;color:#555;display:block;margin-bottom:6px;">${label}</label>
        <input id="${id}-input" class="form-control" value="${defaultValue || ''}" style="margin-bottom:20px;">
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button id="${id}-cancel" class="btn btn-outline-secondary btn-sm">Annuler</button>
          <button id="${id}-ok" class="btn btn-primary btn-sm">Valider</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    const input = document.getElementById(`${id}-input`);
    input.focus();
    document.getElementById(`${id}-cancel`).onclick = () => backdrop.remove();
    document.getElementById(`${id}-ok`).onclick = () => { const v = input.value.trim(); backdrop.remove(); onSubmit(v); };
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const v = input.value.trim(); backdrop.remove(); onSubmit(v); } });
  }

  function uiLoadPatientChoice(patientName, onEmergency, onNormal) {
    const id = `choice-${Date.now()}`;
    const backdrop = document.createElement('div');
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;display:flex;align-items:center;justify-content:center;';
    backdrop.innerHTML = `
      <div style="background:#fff;border-radius:16px;padding:28px 32px;max-width:440px;width:90%;box-shadow:0 8px 40px rgba(0,0,0,.2);">
        <h5 style="margin:0 0 6px;font-weight:700;">Accès au dossier</h5>
        <p style="color:#555;font-size:14px;margin-bottom:20px;">Patient : <strong>${patientName}</strong></p>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <button id="${id}-emergency" class="btn btn-danger w-100"><i class="bi bi-lightning-fill me-2"></i>Mode urgence (accès immédiat)</button>
          <button id="${id}-normal" class="btn btn-primary w-100"><i class="bi bi-shield-check me-2"></i>Consultation normale (avec consentement)</button>
          <button id="${id}-cancel" class="btn btn-outline-secondary w-100">Annuler</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    document.getElementById(`${id}-emergency`).onclick = () => { backdrop.remove(); onEmergency(); };
    document.getElementById(`${id}-normal`).onclick   = () => { backdrop.remove(); onNormal(); };
    document.getElementById(`${id}-cancel`).onclick   = () => backdrop.remove();
  }

  function uiConsentOtp(onSubmit) {
    const id = `otp-consent-${Date.now()}`;
    const backdrop = document.createElement('div');
    backdrop.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;display:flex;align-items:center;justify-content:center;';
    backdrop.innerHTML = `
      <div style="background:#fff;border-radius:16px;padding:28px 32px;max-width:420px;width:90%;box-shadow:0 8px 40px rgba(0,0,0,.2);">
        <h5 style="margin:0 0 6px;font-weight:700;"><i class="bi bi-shield-lock me-2 text-primary"></i>Code de consentement</h5>
        <p style="color:#555;font-size:14px;margin-bottom:16px;">Demandez au patient son code OTP de consentement :</p>
        <div style="display:flex;gap:8px;justify-content:center;margin-bottom:20px;" id="${id}-inputs">
          ${[0,1,2,3,4,5].map((i) => `<input type="text" maxlength="1" class="form-control text-center fw-bold" id="${id}-d${i}" style="width:46px;height:56px;font-size:22px;">`).join('')}
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button id="${id}-cancel" class="btn btn-outline-secondary btn-sm">Annuler</button>
          <button id="${id}-ok" class="btn btn-primary btn-sm"><i class="bi bi-shield-check me-1"></i>Valider</button>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    // navigation entre chiffres
    [0,1,2,3,4,5].forEach((i) => {
      const inp = document.getElementById(`${id}-d${i}`);
      inp.addEventListener('input', () => { inp.value = inp.value.replace(/\D/g,''); if (inp.value && i < 5) document.getElementById(`${id}-d${i+1}`).focus(); });
      inp.addEventListener('keydown', (e) => { if (e.key === 'Backspace' && !inp.value && i > 0) document.getElementById(`${id}-d${i-1}`).focus(); });
    });
    document.getElementById(`${id}-d0`).focus();
    document.getElementById(`${id}-cancel`).onclick = () => backdrop.remove();
    document.getElementById(`${id}-ok`).onclick = () => {
      const code = [0,1,2,3,4,5].map((i) => document.getElementById(`${id}-d${i}`).value).join('');
      if (code.length < 6) { showToast('Entrez les 6 chiffres du code.', 'warning'); return; }
      backdrop.remove(); onSubmit(code);
    };
  }

  function readArrayStorage(key) {
    const parsed = safeParse(localStorage.getItem(key) || '[]', []);
    return Array.isArray(parsed) ? parsed : [];
  }

  function savePatientRegistry() {
    localStorage.setItem(PATIENT_REGISTRY_KEY, JSON.stringify(patientRegistry));
  }

  function addAuditEntry(action, details) {
    const entries = readArrayStorage(PROFESSIONAL_AUDIT_KEY);
    entries.unshift({
      id: `audit-${Date.now()}`,
      at: Date.now(),
      actor: currentUser.name || 'Professionnel',
      role: currentUser.role || 'PRO',
      action,
      details
    });
    localStorage.setItem(PROFESSIONAL_AUDIT_KEY, JSON.stringify(entries.slice(0, 200)));
  }

  document.addEventListener('DOMContentLoaded', function () {
    const token = localStorage.getItem(TOKEN_KEY);
    const userRole = localStorage.getItem(ROLE_KEY);
    const userData = safeParse(localStorage.getItem(USER_KEY) || '{}', {});
    const permissions = safeParse(localStorage.getItem(PERMISSIONS_KEY) || '[]', []);

    if (!token || !['DOCTOR', 'NURSE', 'PHARMACIST', 'ER'].includes(userRole)) {
      window.location.href = 'connexion-professionnel.html';
      return;
    }

    currentUser = userData;

    setText('userName', userData.name || 'Professionnel');
    setText('userRole', getRoleDisplayName(userData.role));
    setText('userInitials', getInitials(userData.name));
    setText('userNameSidebar', userData.name || 'Professionnel');
    setText('userRoleSidebar', getRoleDisplayName(userData.role));

    applyRolePermissions(userData.role, permissions);

    updateConnectionStatus();
    window.addEventListener('offline', updateConnectionStatus);
    window.addEventListener('online', updateConnectionStatus);

    updateClock();
    setInterval(updateClock, 1000);

    initProfessionalWorkspace();
  });

  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function getRoleDisplayName(role) {
    const roles = {
      DOCTOR: 'Medecin',
      NURSE: 'Infirmier(ere)',
      PHARMACIST: 'Pharmacien(ne)',
      ER: 'Urgentiste'
    };
    return roles[role] || role || 'Professionnel';
  }

  function getInitials(name) {
    if (!name) return 'PR';
    return name.split(' ').map((n) => n[0]).join('').substring(0, 2).toUpperCase();
  }

  function applyRolePermissions(role) {
    if (role === 'PHARMACIST' || role === 'NURSE') {
      document.querySelectorAll('[data-permission="prescribe"]').forEach((el) => {
        el.classList.add('permission-disabled');
      });
    }
  }

  function updateConnectionStatus() {
    const indicator = document.getElementById('statusIndicator');
    const text = document.getElementById('statusText');
    if (!indicator || !text) return;

    if (navigator.onLine) {
      indicator.className = 'status-indicator online';
      text.textContent = 'En ligne';
    } else {
      indicator.className = 'status-indicator offline';
      text.textContent = 'Hors ligne - Mode Offline Actif';
    }
  }

  function updateClock() {
    const now = new Date();
    setText('currentTime', now.toLocaleTimeString('fr-FR'));
  }

  function showSection(sectionId, linkElement) {
    document.querySelectorAll('.page-section').forEach((s) => s.classList.remove('active'));
    const section = document.getElementById(sectionId);
    if (section) section.classList.add('active');

    document.querySelectorAll('.sidebar-menu a').forEach((a) => a.classList.remove('active'));
    const activeLink = linkElement || document.querySelector(`.sidebar-menu a[onclick*="${sectionId}"]`);
    if (activeLink) activeLink.classList.add('active');

    if (window.innerWidth < 992) {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) sidebar.classList.remove('show');
    }
  }

  function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.toggle('show');
  }

  function logout() {
    uiConfirm('Voulez-vous vraiment vous déconnecter ?', () => {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(ROLE_KEY);
      localStorage.removeItem(USER_KEY);
      localStorage.removeItem(PERMISSIONS_KEY);
      localStorage.removeItem('sika_refresh_token');
      window.location.href = 'index.html';
    }, { title: 'Déconnexion', confirmLabel: 'Se déconnecter', confirmClass: 'btn-danger' });
  }

  function initProfessionalWorkspace() {
    patientRegistry = readArrayStorage(PATIENT_REGISTRY_KEY);
    bindCreatePatientActions();
    renderPatientsList();
  }

  function normalizePhone(phone) {
    return (phone || '').replace(/[^\d]/g, '');
  }

  function normalizeIdentifier(value) {
    return (value || '').trim();
  }

  function calculateAge(dateIso) {
    if (!dateIso) return '';
    const birth = new Date(dateIso);
    if (Number.isNaN(birth.getTime())) return '';
    const diff = Date.now() - birth.getTime();
    const ageDate = new Date(diff);
    return Math.abs(ageDate.getUTCFullYear() - 1970).toString();
  }

  function findPatientByIdentifier(identifier) {
    const id = normalizeIdentifier(identifier);
    if (!id) return null;
    const upper = id.toUpperCase();
    const phone = normalizePhone(id);
    return patientRegistry.find((record) => {
      const p = record.profile || {};
      return (
        (p.cmu && p.cmu === id) ||
        (p.temporaryId && p.temporaryId.toUpperCase() === upper) ||
        (p.patientId && p.patientId.toUpperCase() === upper) ||
        (normalizePhone(p.phone) === phone)
      );
    }) || null;
  }

  function renderPatientsList(searchTerm) {
    const container = document.getElementById('patientsRecentList');
    if (!container) return;

    const term = (searchTerm || '').trim().toLowerCase();
    const rows = patientRegistry.filter((record) => {
      if (!term) return true;
      const p = record.profile || {};
      const fullName = `${p.firstName || ''} ${p.lastName || ''}`.trim().toLowerCase();
      return fullName.includes(term) ||
        (p.cmu || '').toLowerCase().includes(term) ||
        normalizePhone(p.phone || '').includes(normalizePhone(term));
    });

    if (!rows.length) {
      container.innerHTML = '<p class="text-muted mb-0">Aucun patient. Creez un dossier patient.</p>';
      return;
    }

    container.innerHTML = rows.map((record) => {
      const p = record.profile || {};
      const m = record.medical || {};
      const name = `${p.firstName || ''} ${p.lastName || ''}`.trim() || 'Patient';
      const id = p.cmu || p.temporaryId || p.patientId;
      const age = calculateAge(p.dateOfBirth);
      const lastConsult = (m.consultations && m.consultations[0] && m.consultations[0].date) || 'N/A';
      const statusBadge = p.accountStatus === 'ACTIVE'
        ? '<span class="badge bg-success ms-1" style="font-size:10px;">Actif</span>'
        : '<span class="badge bg-warning text-dark ms-1" style="font-size:10px;">En attente</span>';
      return `
        <div class="patient-card d-flex justify-content-between align-items-center" style="cursor:default;">
          <div onclick="loadPatient('${id}')" style="cursor:pointer;flex:1;">
            <strong>${name}</strong> ${statusBadge} <span class="text-muted">(ID: ${id})</span><br>
            <small class="text-muted">${age ? `${age} ans` : 'Age N/A'} - Derniere consultation: ${lastConsult}</small>
          </div>
          <div class="d-flex gap-2 ms-3">
            <button class="btn btn-sm btn-outline-primary" title="Modifier" onclick="openEditPatient('${record.patientId}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" title="Supprimer" onclick="confirmDeletePatient('${record.patientId}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  function openEditPatient(patientId) {
    const record = patientRegistry.find((r) => r.patientId === patientId);
    if (!record) return;
    const p = record.profile || {};
    const m = record.medical || {};

    document.getElementById('editPatientId').value = patientId;
    document.getElementById('editFirstName').value = p.firstName || '';
    document.getElementById('editLastName').value = p.lastName || '';
    document.getElementById('editPhone').value = p.phone || '';
    document.getElementById('editCmu').value = p.cmu || '';
    document.getElementById('editDob').value = p.dateOfBirth || '';
    document.getElementById('editSex').value = p.sex || '';
    document.getElementById('editAddress').value = p.address || '';
    document.getElementById('editEmergencyName').value = (p.emergencyContact && p.emergencyContact.name) || '';
    document.getElementById('editEmergencyPhone').value = (p.emergencyContact && p.emergencyContact.phone) || '';
    document.getElementById('editBloodGroup').value = m.bloodType || '';
    document.getElementById('editAllergies').value = (m.allergies || []).map((a) => a.label).join(', ');
    document.getElementById('editChronicDiseases').value = m.chronicDiseases || '';
    document.getElementById('editNotes').value = m.notes || '';

    const modal = new bootstrap.Modal(document.getElementById('editPatientModal'));
    modal.show();
  }

  function saveEditPatient() {
    const patientId = document.getElementById('editPatientId').value;
    const idx = patientRegistry.findIndex((r) => r.patientId === patientId);
    if (idx < 0) return;

    const firstName = document.getElementById('editFirstName').value.trim();
    const lastName = document.getElementById('editLastName').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    if (!firstName || !lastName || !phone) {
      showToast('Prénom, nom et téléphone sont obligatoires.', 'warning');
      return;
    }

    const allergiesRaw = document.getElementById('editAllergies').value.trim();
    const allergies = allergiesRaw
      ? allergiesRaw.split(',').map((a) => ({ label: a.trim(), status: 'DECLARED' })).filter((a) => a.label)
      : [];

    patientRegistry[idx].profile.firstName = firstName;
    patientRegistry[idx].profile.lastName = lastName;
    patientRegistry[idx].profile.phone = phone;
    patientRegistry[idx].profile.cmu = document.getElementById('editCmu').value.trim() || patientRegistry[idx].profile.cmu;
    patientRegistry[idx].profile.dateOfBirth = document.getElementById('editDob').value.trim();
    patientRegistry[idx].profile.sex = document.getElementById('editSex').value.trim();
    patientRegistry[idx].profile.address = document.getElementById('editAddress').value.trim();
    patientRegistry[idx].profile.emergencyContact = {
      name: document.getElementById('editEmergencyName').value.trim(),
      phone: document.getElementById('editEmergencyPhone').value.trim()
    };
    if (!patientRegistry[idx].medical) patientRegistry[idx].medical = {};
    patientRegistry[idx].medical.bloodType = document.getElementById('editBloodGroup').value.trim();
    patientRegistry[idx].medical.allergies = allergies;
    patientRegistry[idx].medical.chronicDiseases = document.getElementById('editChronicDiseases').value.trim();
    patientRegistry[idx].medical.notes = document.getElementById('editNotes').value.trim();
    patientRegistry[idx].medical.updatedAt = new Date().toISOString();

    savePatientRegistry();
    addAuditEntry('UPDATE_PATIENT', `Patient ${firstName} ${lastName} (${patientId}) modifie`);
    renderPatientsList();

    bootstrap.Modal.getInstance(document.getElementById('editPatientModal')).hide();
    showToast('Dossier patient modifié avec succès.', 'success');
  }

  function confirmDeletePatient(patientId) {
    const record = patientRegistry.find((r) => r.patientId === patientId);
    if (!record) return;
    const p = record.profile || {};
    const name = `${p.firstName || ''} ${p.lastName || ''}`.trim() || 'ce patient';
    uiConfirm(
      `Supprimer définitivement le dossier de <strong>${name}</strong> ? Cette action est irréversible.`,
      () => {
        patientRegistry = patientRegistry.filter((r) => r.patientId !== patientId);
        savePatientRegistry();
        addAuditEntry('DELETE_PATIENT', `Patient ${name} (${patientId}) supprime`);
        renderPatientsList();
        showToast(`Dossier de ${name} supprimé.`, 'danger');
      },
      { title: 'Supprimer le dossier', confirmLabel: 'Supprimer', confirmClass: 'btn-danger' }
    );
  }

  function openCreatePatient() {
    showSection('section-create-patient');
  }

  function bindCreatePatientActions() {
    const sendBtn = document.getElementById('createPatientSendOtpBtn');
    const printBtn = document.getElementById('createPatientPrintQrBtn');
    if (sendBtn) sendBtn.addEventListener('click', () => createPatientRecord('otp'));
    if (printBtn) printBtn.addEventListener('click', () => createPatientRecord('print'));
  }

  function generatePatientId() {
    return `PAT-${Date.now().toString().slice(-8)}`;
  }

  function generateTemporaryId() {
    return `PROV-${Math.random().toString(36).slice(2, 8).toUpperCase()}`;
  }

  function simpleChecksum(input) {
    let hash = 0;
    for (let i = 0; i < input.length; i += 1) {
      hash = ((hash << 5) - hash) + input.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash).toString(16).toUpperCase().slice(0, 8);
  }

  function buildPatientQrPayload(patientId) {
    const raw = `PID:${patientId}|TS:${Date.now()}`;
    return `${raw}|SIG:${simpleChecksum(raw)}`;
  }

  function createPatientRecord(mode) {
    const firstName = (document.getElementById('newPatientFirstName')?.value || '').trim();
    const lastName = (document.getElementById('newPatientLastName')?.value || '').trim();
    const phone = (document.getElementById('newPatientPhone')?.value || '').trim();
    const cmu = (document.getElementById('newPatientCmu')?.value || '').trim();
    const dateOfBirth = (document.getElementById('newPatientDob')?.value || '').trim();
    const sex = (document.getElementById('newPatientSex')?.value || '').trim();
    const address = (document.getElementById('newPatientAddress')?.value || '').trim();
    const emergencyName = (document.getElementById('newPatientEmergencyName')?.value || '').trim();
    const emergencyPhone = (document.getElementById('newPatientEmergencyPhone')?.value || '').trim();

    const bloodGroup = (document.getElementById('newPatientBloodGroup')?.value || '').trim();
    const bloodGroupStatus = (document.getElementById('newPatientBloodStatus')?.value || 'DECLARED').trim();
    const allergiesRaw = (document.getElementById('newPatientAllergies')?.value || '').trim();
    const allergiesStatus = (document.getElementById('newPatientAllergiesStatus')?.value || 'DECLARED').trim();
    const chronicDiseases = (document.getElementById('newPatientChronic')?.value || '').trim();
    const antecedents = (document.getElementById('newPatientAntecedents')?.value || '').trim();
    const treatments = (document.getElementById('newPatientTreatments')?.value || '').trim();
    const vaccines = (document.getElementById('newPatientVaccines')?.value || '').trim();
    const notes = (document.getElementById('newPatientMedicalNotes')?.value || '').trim();

    if (!firstName || !lastName || !phone) {
      showToast('Nom, prénom et téléphone OTP sont obligatoires.', 'warning');
      return;
    }

    const phoneNorm = normalizePhone(phone);
    if (phoneNorm.length < 8) {
      showToast('Numéro de téléphone invalide (minimum 8 chiffres).', 'warning');
      return;
    }

    if (cmu && !/^\d{10}$/.test(cmu)) {
      showToast('Le numéro CMU doit contenir exactement 10 chiffres.', 'warning');
      return;
    }

    const duplicate = patientRegistry.find((record) => {
      const p = record.profile || {};
      return (cmu && p.cmu === cmu) || normalizePhone(p.phone) === phoneNorm;
    });
    if (duplicate) {
      showToast('Un patient existe déjà avec ce CMU ou ce téléphone.', 'danger');
      return;
    }

    const patientId = generatePatientId();
    const temporaryId = cmu ? null : generateTemporaryId();
    const identifier = cmu || temporaryId || phoneNorm;
    const qrPayload = buildPatientQrPayload(patientId);
    const nowIso = new Date().toISOString();

    const record = {
      patientId,
      profile: {
        patientId,
        cmu: cmu || null,
        temporaryId,
        firstName,
        lastName,
        phone,
        dateOfBirth: dateOfBirth || null,
        sex: sex || null,
        address: address || '',
        emergencyContact: {
          name: emergencyName || '',
          phone: emergencyPhone || ''
        },
        createdByCenter: 'CHU de Cocody',
        createdByProfessional: currentUser.name || 'Professionnel',
        createdAt: nowIso,
        accountStatus: 'PENDING_ACTIVATION',
        activatedAt: null
      },
      medical: {
        bloodType: bloodGroup || null,
        bloodTypeStatus: bloodGroup ? bloodGroupStatus : null,
        allergies: allergiesRaw
          ? allergiesRaw.split(',').map((item) => ({ label: item.trim(), status: allergiesStatus })).filter((item) => !!item.label)
          : [],
        chronicDiseases: chronicDiseases || '',
        antecedents: antecedents || '',
        treatments: treatments ? treatments.split(',').map((item) => item.trim()).filter(Boolean) : [],
        vaccines: vaccines ? vaccines.split(',').map((item) => item.trim()).filter(Boolean) : [],
        notes: notes || '',
        consultations: [],
        prescriptions: [],
        exams: [],
        updatedAt: nowIso,
        updatedBy: currentUser.name || 'Professionnel'
      },
      consent: {
        pendingRequests: [],
        granted: [],
        history: []
      },
      account: {
        identifier,
        otpPhone: phone,
        status: 'PENDING_ACTIVATION',
        createdByRole: currentUser.role || 'PRO'
      },
      qr: {
        payload: qrPayload,
        generatedAt: nowIso
      }
    };

    patientRegistry.unshift(record);
    savePatientRegistry();
    addAuditEntry('CREATE_PATIENT', `Patient ${firstName} ${lastName} (${identifier}) cree`);
    renderPatientsList();

    const form = document.getElementById('createPatientForm');
    if (form) form.reset();
    showSection('section-patients');
    if (mode === 'otp') {
      showToast(`Patient ${firstName} ${lastName} créé — ID: ${identifier}`, 'success');
    } else {
      showToast(`Patient ${firstName} ${lastName} créé — QR généré`, 'success');
    }
  }

  function openScanner() {
    document.getElementById('scannerModal').classList.add('show');
  }

  function closeScanner() {
    document.getElementById('scannerModal').classList.remove('show');
  }

  function simulateScan() {
    uiPrompt('CMU, ID provisoire ou téléphone du patient', '', (identifier) => {
      if (!identifier) return;
      loadPatient(identifier);
      closeScanner();
    }, { title: 'Scanner un patient' });
  }

  function searchPatient() {
    const query = document.getElementById('searchCMU')?.value || '';
    if (!query) {
      renderPatientsList();
      return;
    }
    const exact = findPatientByIdentifier(query);
    if (exact) {
      loadPatient(query);
    } else {
      renderPatientsList(query);
    }
  }

  function loadPatient(identifier) {
    const record = findPatientByIdentifier(identifier);
    if (!record) {
      showToast('Patient introuvable. Créez d\'abord son dossier.', 'danger');
      return;
    }
    currentPatient = record;
    const p = record.profile || {};
    const name = `${p.firstName || ''} ${p.lastName || ''}`.trim() || 'Patient';
    uiLoadPatientChoice(name, showEmergencyMode, requestConsent);
  }

  function showEmergencyMode() {
    if (!currentPatient) return;
    const p = currentPatient.profile || {};
    const name = `${p.firstName || ''} ${p.lastName || ''}`.trim() || 'Patient';
    const id = p.cmu || p.temporaryId || p.patientId;
    showToast('Mode urgence activé — accès journalisé.', 'danger');
    showSection('section-emergency-view');
    setText('emergencyPatientName', name);
    setText('emergencyPatientCMU', id || '-');
    addAuditEntry('EMERGENCY_ACCESS', `Acces urgence ${name} (${id})`);
  }

  function requestConsent() {
    if (!currentPatient) return;
    uiConsentOtp((otp) => {
      if (!otp) return;
      showToast('Consentement validé — accès autorisé.', 'success');
      addAuditEntry('CONSENT_VALIDATED', `Consentement patient ${currentPatient.patientId}`);
      showSection('section-patient-file');
      loadPatientFile();
    });
  }

  function loadPatientFile() {
    if (!currentPatient) return;
    const p = currentPatient.profile || {};
    const m = currentPatient.medical || {};
    const name = `${p.firstName || ''} ${p.lastName || ''}`.trim();
    const id = p.cmu || p.temporaryId || p.patientId;
    const age = calculateAge(p.dateOfBirth);

    setText('patientFileName', name || 'Patient');
    setText('patientFileCMU', id || '-');
    setText('consultationCurrentPatient', `${name || 'Patient'} (${id || '-'})`);

    const subtitle = document.querySelector('#section-patient-file p.text-muted');
    if (subtitle) subtitle.textContent = `ID: ${id} - ${age ? `${age} ans` : 'Age N/A'} - ${p.sex || 'Sexe N/A'}`;

    const vitalCard = document.querySelector('#section-patient-file .section-card');
    if (vitalCard) {
      const allergies = (m.allergies || []).map((a) => `${a.label} (${a.status === 'CONFIRMED' ? 'confirmee' : 'declaree'})`).join(', ') || 'Aucune';
      vitalCard.innerHTML = `
        <h4>Informations Vitales</h4>
        <div class="row">
          <div class="col-md-3">
            <label class="text-muted small">Groupe Sanguin</label>
            <p><strong>${m.bloodType || 'N/A'}</strong></p>
          </div>
          <div class="col-md-4">
            <label class="text-muted small">Allergies</label>
            <p><strong class="text-danger">${allergies}</strong></p>
          </div>
          <div class="col-md-5">
            <label class="text-muted small">Maladies Chroniques</label>
            <p><strong>${m.chronicDiseases || 'Aucune'}</strong></p>
          </div>
        </div>
      `;
    }
  }

  function updateCurrentPatientRecord(mutator) {
    if (!currentPatient || !currentPatient.patientId) return false;
    const idx = patientRegistry.findIndex((record) => record.patientId === currentPatient.patientId);
    if (idx < 0) return false;
    mutator(patientRegistry[idx]);
    currentPatient = patientRegistry[idx];
    savePatientRegistry();
    renderPatientsList();
    return true;
  }

  function saveConsultation() {
    if (!currentPatient) {
      showToast('Chargez d\'abord un patient.', 'warning');
      return;
    }

    const symptoms = (document.getElementById('symptoms')?.value || '').trim();
    const diagnosis = (document.getElementById('diagnosis')?.value || '').trim();
    if (!symptoms || !diagnosis) {
      showToast('Veuillez remplir tous les champs obligatoires.', 'warning');
      return;
    }

    updateCurrentPatientRecord((record) => {
      const medical = record.medical || {};
      medical.consultations = Array.isArray(medical.consultations) ? medical.consultations : [];
      medical.consultations.unshift({
        id: `CONS-${Date.now()}`,
        date: new Date().toLocaleDateString('fr-FR'),
        doctor: currentUser.name || 'Professionnel',
        center: 'CHU de Cocody',
        specialty: getRoleDisplayName(currentUser.role || 'DOCTOR'),
        symptoms,
        diagnosis
      });
      medical.updatedAt = new Date().toISOString();
      medical.updatedBy = currentUser.name || 'Professionnel';
      record.medical = medical;
    });

    addAuditEntry('ADD_CONSULTATION', `Consultation ajoutee pour ${currentPatient.patientId}`);
    if (!navigator.onLine) {
      showToast('Hors ligne — la consultation sera synchronisée à la reconnexion.', 'warning');
    } else {
      showToast('Consultation enregistrée avec succès.', 'success');
    }
    showSection('section-dashboard');
  }

  function generatePrescription() {
    if (!currentPatient) {
      showToast('Chargez d\'abord un patient.', 'warning');
      return;
    }

    if (!currentUser.role || currentUser.role === 'NURSE') {
      showToast('Vous n\'avez pas la permission de prescrire.', 'danger');
      return;
    }

    updateCurrentPatientRecord((record) => {
      const medical = record.medical || {};
      medical.prescriptions = Array.isArray(medical.prescriptions) ? medical.prescriptions : [];
      const ref = `ORD-${Date.now().toString().slice(-6)}`;
      medical.prescriptions.unshift({
        id: ref,
        date: new Date().toLocaleDateString('fr-FR'),
        doctor: currentUser.name || 'Professionnel',
        items: ['Paracetamol 500mg - 3x/j'],
        status: 'ACTIVE',
        qrCode: `QR-${ref}`
      });
      medical.updatedAt = new Date().toISOString();
      medical.updatedBy = currentUser.name || 'Professionnel';
      record.medical = medical;
    });

    addAuditEntry('ADD_PRESCRIPTION', `Ordonnance creee pour ${currentPatient.patientId}`);
    showToast('Ordonnance électronique créée.', 'success');
    showSection('section-ordonnances');
  }

  function addMockExam() {
    if (!currentPatient) {
      showToast('Chargez d\'abord un patient.', 'warning');
      return;
    }
    uiPrompt('Nom de l\'examen', 'Bilan sanguin complet', (examName) => {
      if (!examName) return;

      updateCurrentPatientRecord((record) => {
        const medical = record.medical || {};
        medical.exams = Array.isArray(medical.exams) ? medical.exams : [];
        medical.exams.unshift({
          id: `EXAM-${Date.now()}`,
          name: examName,
          date: new Date().toLocaleDateString('fr-FR'),
          lab: 'Laboratoire SIKA (mock)',
          result: 'En attente'
        });
        medical.updatedAt = new Date().toISOString();
        medical.updatedBy = currentUser.name || 'Professionnel';
        record.medical = medical;
      });
      addAuditEntry('ADD_EXAM', `Examen prescrit pour ${currentPatient.patientId}`);
      showToast(`Examen "${examName}" prescrit.`, 'success');
      showSection('section-examens');
    }, { title: 'Prescrire un examen' });
  }

  function updatePatientMedicalInfo() {
    if (!currentPatient) {
      showToast('Chargez d\'abord un patient.', 'warning');
      return;
    }
    // Utilise le modal d'édition directement pour éviter les prompt/confirm chainés
    openEditPatient(currentPatient.patientId);
  }
</script>
  </head>
  <body>

    <!-- ======= Header =======-->
    <header class="pro-header">
      <button class="btn btn-link d-lg-none me-2" onclick="toggleSidebar()">
        <i class="bi bi-list fs-3"></i>
      </button>

      <img src="assets/images/logo-dark.svg" alt="Sika-Santé" height="40" class="me-3">

      <div class="user-info">
        <div class="user-avatar" id="userInitials">DK</div>
        <div class="d-none d-md-block">
          <strong id="userName">Dr. Jean KOUASSI</strong><br>
          <span class="role-badge" id="userRole">Médecin</span>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-3">
        <button class="btn btn-link position-relative">
          <i class="bi bi-bell fs-5"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            5
          </span>
        </button>

        <button class="scan-btn" onclick="openScanner()">
          <i class="bi bi-qr-code-scan"></i>
          Scanner Patient
        </button>

        <button class="btn btn-link" onclick="logout()">
          <i class="bi bi-box-arrow-right fs-5"></i>
        </button>
      </div>
    </header>

    <!-- ======= Sidebar =======-->
    <aside class="sidebar">
      <div class="p-3 border-bottom">
        <strong id="userNameSidebar">Dr. Jean KOUASSI</strong>
        <br><span class="role-badge" id="userRoleSidebar">Médecin</span>
        <br><small class="text-muted">CHU de Cocody</small>
      </div>

      <ul class="sidebar-menu">
        <li><a href="#" onclick="showSection('section-dashboard', this); return false;" class="active">
          <i class="bi bi-grid"></i>
          <span>Tableau de Bord</span>
        </a></li>

        <li><a href="#" onclick="openScanner()">
          <i class="bi bi-qr-code-scan"></i>
          <span>Scanner un Patient</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-create-patient', this); return false;">
          <i class="bi bi-person-plus"></i>
          <span>Creer un Patient</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-patients', this); return false;">
          <i class="bi bi-people"></i>
          <span>Dossiers Patients</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-consultation', this); return false;" data-permission="consult">
          <i class="bi bi-clipboard-plus"></i>
          <span>Nouvelle Consultation</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-ordonnances', this); return false;" data-permission="prescribe">
          <i class="bi bi-prescription2"></i>
          <span>Ordonnances</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-examens', this); return false;">
          <i class="bi bi-file-earmark-medical"></i>
          <span>Examens & Résultats</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-historique', this); return false;">
          <i class="bi bi-clock-history"></i>
          <span>Historique & Traçabilité</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-alertes', this); return false;">
          <i class="bi bi-exclamation-triangle"></i>
          <span>Messages / Alertes</span>
        </a></li>

        <li><a href="#" onclick="showSection('section-parametres', this); return false;">
          <i class="bi bi-gear"></i>
          <span>Paramètres</span>
        </a></li>
      </ul>
    </aside>

    <!-- ======= Main Content =======-->
    <main class="main-content">

      <!-- ====== SECTION: TABLEAU DE BORD ====== -->
      <div id="section-dashboard" class="page-section active">
        <h3 class="mb-4">Tableau de Bord</h3>

        <!-- Statistiques -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="number">12</div>
              <div class="label">Patients vus aujourd'hui</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="border-left-color: #f39c12;">
              <div class="number" style="color: #f39c12;">5</div>
              <div class="label">Patients en attente</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="border-left-color: #e74c3c;">
              <div class="number" style="color: #e74c3c;">2</div>
              <div class="label">Alertes critiques</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card" style="border-left-color: #2ecc71;">
              <div class="number" style="color: #2ecc71;">8</div>
              <div class="label">Ordonnances créées</div>
            </div>
          </div>
        </div>

        <!-- Actions Rapides -->
        <h4 class="mb-3">Actions Rapides</h4>
        <div class="row g-3 mb-4">
          <div class="col-md-3 col-6">
            <div class="quick-action-pro" onclick="openScanner()">
              <i class="bi bi-qr-code-scan"></i>
              <h5>Scanner Patient</h5>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="quick-action-pro" onclick="showSection('section-consultation')">
              <i class="bi bi-clipboard-plus"></i>
              <h5>Nouvelle Consultation</h5>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="quick-action-pro" onclick="showSection('section-ordonnances')">
              <i class="bi bi-prescription2"></i>
              <h5>Ordonnances</h5>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="quick-action-pro" onclick="showSection('section-emergency-view')" style="border-color: #e74c3c;">
              <i class="bi bi-heart-pulse" style="color: #e74c3c;"></i>
              <h5>Mode Urgence</h5>
            </div>
          </div>
        </div>

        <!-- Alertes Critiques -->
        <h4 class="mb-3">Alertes Critiques</h4>
        <div class="alert-critical danger">
          <i class="bi bi-exclamation-triangle fs-3 text-danger"></i>
          <div class="flex-grow-1">
            <strong>Allergie Pénicilline - Patient KONÉ Marie (CMU: 0987654321)</strong><br>
            <small>Détectée lors de la prescription - Il y a 15 minutes</small>
          </div>
          <button class="btn btn-sm btn-danger">Voir</button>
        </div>

        <div class="alert-critical">
          <i class="bi bi-capsule fs-3 text-warning"></i>
          <div class="flex-grow-1">
            <strong>Interaction médicamenteuse possible - Patient TRAORÉ Ibrahim</strong><br>
            <small>Warfarine + Aspirine - À vérifier</small>
          </div>
          <button class="btn btn-sm btn-warning">Voir</button>
        </div>

        <!-- Dernières Consultations -->
        <h4 class="mb-3 mt-4">Dernières Consultations</h4>
        <div class="section-card">
          <div class="list-group">
            <div class="patient-card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>KOUASSI Jean</strong> <span class="text-muted">(CMU: 1234567890)</span><br>
                  <small class="text-muted">40 ans - Contrôle cardiologie - 14:30</small>
                </div>
                <button class="btn btn-sm btn-outline-primary">Voir dossier</button>
              </div>
            </div>

            <div class="patient-card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>KONÉ Marie</strong> <span class="text-muted">(CMU: 0987654321)</span><br>
                  <small class="text-muted">35 ans - Consultation générale - 13:45</small>
                </div>
                <button class="btn btn-sm btn-outline-primary">Voir dossier</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- ====== SECTION: MODE URGENCE ====== -->
      <div id="section-emergency-view" class="page-section">
        <div class="alert alert-danger">
          <h4><i class="bi bi-exclamation-triangle me-2"></i>MODE URGENCE ACTIVÉ</h4>
          <p class="mb-0">Accès immédiat sans consentement. Consultation journalisée automatiquement.</p>
        </div>

        <div class="vital-info-emergency">
          <h3>🚨 Informations Vitales - <span id="emergencyPatientName">Patient</span></h3>
          <p class="mb-0">CMU: <strong id="emergencyPatientCMU">-</strong></p>

          <div class="vital-grid">
            <div class="vital-item">
              <label>🩸 Groupe Sanguin</label>
              <strong style="font-size: 32px;">O+</strong>
            </div>
            <div class="vital-item">
              <label>⚠️ ALLERGIES CRITIQUES</label>
              <strong style="color: #ffeb3b;">Pénicilline</strong>
            </div>
            <div class="vital-item">
              <label>💊 Traitements en Cours</label>
              <strong>Aucun</strong>
            </div>
            <div class="vital-item">
              <label>🏥 Maladies Graves</label>
              <strong>Aucune</strong>
            </div>
            <div class="vital-item">
              <label>📞 Contact Urgence</label>
              <strong>Marie KOUASSI<br>+225 07 01 23 45 68</strong>
            </div>
            <div class="vital-item">
              <label>🕐 Dernière Consultation</label>
              <strong>25 Jan 2025</strong>
            </div>
          </div>
        </div>

        <button class="btn btn-danger btn-lg">
          <i class="bi bi-clipboard-plus me-2"></i>
          Saisir Intervention d'Urgence
        </button>
      </div>

      <!-- ====== SECTION: DOSSIER PATIENT ====== -->
      <div id="section-patient-file" class="page-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h3 class="mb-1" id="patientFileName">KOUASSI Jean</h3>
            <p class="text-muted mb-0">CMU: <span id="patientFileCMU">1234567890</span> - 40 ans - Homme</p>
          </div>
          <button class="btn btn-outline-primary">
            <i class="bi bi-printer me-2"></i>
            Imprimer
          </button>
        </div>

        <!-- Tabs -->
        <div class="tab-nav">
          <button class="active">Infos Vitales</button>
          <button>Antécédents</button>
          <button>Consultations</button>
          <button>Examens</button>
          <button>Ordonnances</button>
          <button>Vaccins</button>
        </div>

        <!-- Contenu onglets (simplifié) -->
        <div class="section-card">
          <h4>Informations Vitales</h4>
          <div class="row">
            <div class="col-md-3">
              <label class="text-muted small">Groupe Sanguin</label>
              <p><strong>O+</strong></p>
            </div>
            <div class="col-md-3">
              <label class="text-muted small">Allergies</label>
              <p><strong class="text-danger">Pénicilline</strong></p>
            </div>
            <div class="col-md-6">
              <label class="text-muted small">Maladies Chroniques</label>
              <p><strong>Aucune</strong></p>
            </div>
          </div>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="updatePatientMedicalInfo()">
            <i class="bi bi-pencil-square me-1"></i>Mettre a jour allergies / chroniques
          </button>
        </div>

      </div>

      <!-- ====== SECTION: CREER PATIENT ====== -->
      <div id="section-create-patient" class="page-section">
        <h3 class="mb-4">Creer un Patient</h3>

        <form id="createPatientForm">
          <div class="section-card">
            <h4><i class="bi bi-person-vcard"></i> Etape 1 - Identite</h4>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Prenom *</label>
                <input type="text" class="form-control" id="newPatientFirstName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nom *</label>
                <input type="text" class="form-control" id="newPatientLastName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Telephone OTP *</label>
                <input type="tel" class="form-control" id="newPatientPhone" placeholder="+225 07 00 00 00 00" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Numero CMU (option)</label>
                <input type="text" class="form-control" id="newPatientCmu" placeholder="1234567890">
              </div>
              <div class="col-md-4">
                <label class="form-label">Date de naissance</label>
                <input type="date" class="form-control" id="newPatientDob">
              </div>
              <div class="col-md-4">
                <label class="form-label">Sexe</label>
                <select class="form-select" id="newPatientSex">
                  <option value="">Non precise</option>
                  <option value="M">Homme</option>
                  <option value="F">Femme</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Adresse</label>
                <input type="text" class="form-control" id="newPatientAddress" placeholder="Commune / Quartier">
              </div>
              <div class="col-md-6">
                <label class="form-label">Contact urgence - Nom</label>
                <input type="text" class="form-control" id="newPatientEmergencyName">
              </div>
              <div class="col-md-6">
                <label class="form-label">Contact urgence - Telephone</label>
                <input type="tel" class="form-control" id="newPatientEmergencyPhone">
              </div>
            </div>
          </div>

          <div class="section-card">
            <h4><i class="bi bi-heart-pulse"></i> Etape 2 - Informations medicales initiales</h4>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Groupe sanguin</label>
                <input type="text" class="form-control" id="newPatientBloodGroup" placeholder="Ex: O+">
              </div>
              <div class="col-md-4">
                <label class="form-label">Statut groupe sanguin</label>
                <select class="form-select" id="newPatientBloodStatus">
                  <option value="DECLARED">Declare</option>
                  <option value="CONFIRMED">Confirme</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Statut allergies</label>
                <select class="form-select" id="newPatientAllergiesStatus">
                  <option value="DECLARED">Declare</option>
                  <option value="CONFIRMED">Confirme</option>
                </select>
              </div>
              <div class="col-md-12">
                <label class="form-label">Allergies (separees par virgules)</label>
                <textarea class="form-control" id="newPatientAllergies" rows="2" placeholder="Penicilline, Arachide"></textarea>
              </div>
              <div class="col-md-12">
                <label class="form-label">Maladies chroniques</label>
                <textarea class="form-control" id="newPatientChronic" rows="2"></textarea>
              </div>
              <div class="col-md-12">
                <label class="form-label">Antecedents importants</label>
                <textarea class="form-control" id="newPatientAntecedents" rows="2"></textarea>
              </div>
              <div class="col-md-12">
                <label class="form-label">Traitements en cours (virgules)</label>
                <textarea class="form-control" id="newPatientTreatments" rows="2"></textarea>
              </div>
              <div class="col-md-12">
                <label class="form-label">Vaccins connus (virgules)</label>
                <textarea class="form-control" id="newPatientVaccines" rows="2"></textarea>
              </div>
              <div class="col-md-12">
                <label class="form-label">Notes medicales</label>
                <textarea class="form-control" id="newPatientMedicalNotes" rows="3"></textarea>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button type="button" class="btn btn-primary btn-lg" id="createPatientSendOtpBtn">
              <i class="bi bi-send me-2"></i>Creer + envoyer OTP
            </button>
            <button type="button" class="btn btn-outline-primary btn-lg" id="createPatientPrintQrBtn">
              <i class="bi bi-qr-code me-2"></i>Creer + imprimer QR
            </button>
          </div>
        </form>
      </div>

      <!-- ====== SECTION: NOUVELLE CONSULTATION ====== -->
      <div id="section-consultation" class="page-section">
        <h3 class="mb-4">Nouvelle Consultation</h3>

        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Patient : <strong id="consultationCurrentPatient">Aucun patient charge</strong>
        </div>

        <div class="section-card">
          <h4><i class="bi bi-heart-pulse"></i> Constantes</h4>
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Tension (mmHg)</label>
              <input type="text" class="form-control" placeholder="120/80">
            </div>
            <div class="col-md-3">
              <label class="form-label">Température (°C)</label>
              <input type="number" class="form-control" placeholder="37.0" step="0.1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Poids (kg)</label>
              <input type="number" class="form-control" placeholder="70">
            </div>
            <div class="col-md-3">
              <label class="form-label">Fréquence Cardiaque</label>
              <input type="number" class="form-control" placeholder="75">
            </div>
          </div>
        </div>

        <div class="section-card">
          <h4><i class="bi bi-clipboard"></i> Symptômes</h4>
          <textarea class="form-control" id="symptoms" rows="4" placeholder="Décrire les symptômes..."></textarea>
        </div>

        <div class="section-card">
          <h4><i class="bi bi-clipboard-check"></i> Diagnostic</h4>
          <textarea class="form-control" id="diagnosis" rows="4" placeholder="Diagnostic..."></textarea>
        </div>

        <div class="section-card" data-permission="prescribe">
          <h4><i class="bi bi-prescription2"></i> Prescription</h4>
          <button class="btn btn-outline-primary" onclick="generatePrescription()">
            <i class="bi bi-plus-circle me-2"></i>
            Générer une Ordonnance
          </button>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-lg" onclick="saveConsultation()">
            <i class="bi bi-save me-2"></i>
            Enregistrer
          </button>
          <button class="btn btn-outline-secondary btn-lg" onclick="showSection('section-dashboard')">
            Annuler
          </button>
        </div>

      </div>

      <!-- ====== SECTION: ORDONNANCES ====== -->
      <div id="section-ordonnances" class="page-section">
        <h3 class="mb-4">E-Ordonnances</h3>

        <button class="btn btn-primary mb-4" data-permission="prescribe" onclick="generatePrescription()">
          <i class="bi bi-plus-circle me-2"></i>
          Créer une Ordonnance
        </button>

        <div class="section-card">
          <h4>Ordonnances Récentes</h4>
          <div class="list-group">
            <div class="patient-card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>ORD-2025-001</strong> - KOUASSI Jean<br>
                  <small class="text-muted">25 Jan 2025 - Paracétamol 500mg, Vitamine C</small>
                </div>
                <div class="text-end">
                  <span class="badge bg-success">Délivrée</span><br>
                  <button class="btn btn-sm btn-outline-primary mt-2">
                    <i class="bi bi-qr-code"></i> QR Code
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== SECTION: EXAMENS ====== -->
      <div id="section-examens" class="page-section">
        <h3 class="mb-4">Examens & Résultats</h3>

        <button class="btn btn-primary mb-4" onclick="addMockExam()">
          <i class="bi bi-plus-circle me-2"></i>
          Prescrire un Examen
        </button>

        <div class="section-card">
          <h4>Examens en Attente de Résultats</h4>
          <p class="text-muted">Aucun examen en attente</p>
        </div>

        <div class="section-card">
          <h4>Résultats Récents</h4>
          <div class="list-group">
            <div class="patient-card">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Bilan Sanguin Complet</strong> - KOUASSI Jean<br>
                  <small class="text-muted">20 Jan 2025 - Laboratoire BIOLAB</small>
                </div>
                <div>
                  <span class="badge bg-success">Normal</span>
                  <button class="btn btn-sm btn-outline-primary ms-2">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ====== SECTION: HISTORIQUE ====== -->
      <div id="section-historique" class="page-section">
        <h3 class="mb-4">Historique & Traçabilité</h3>

        <div class="section-card">
          <h4><i class="bi bi-clock-history"></i> Journal des Accès</h4>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Date/Heure</th>
                  <th>Patient</th>
                  <th>Soignant</th>
                  <th>Centre</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>04 Fév 2025 14:30</td>
                  <td>KOUASSI Jean</td>
                  <td>Dr. KOUASSI Jean</td>
                  <td>CHU Cocody</td>
                  <td>Consultation complète</td>
                </tr>
                <tr>
                  <td>03 Fév 2025 09:15</td>
                  <td>KONÉ Marie</td>
                  <td>Dr. KOUASSI Jean</td>
                  <td>CHU Cocody</td>
                  <td>Vue infos vitales</td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="text-muted mb-0">
            <small><i class="bi bi-info-circle me-1"></i>Tous les accès sont enregistrés conformément aux exigences ARTCI</small>
          </p>
        </div>
      </div>

      <!-- ====== SECTION: ALERTES ====== -->
      <div id="section-alertes" class="page-section">
        <h3 class="mb-4">Messages & Alertes</h3>

        <div class="alert-critical danger">
          <i class="bi bi-exclamation-triangle fs-3 text-danger"></i>
          <div class="flex-grow-1">
            <strong>Allergie Critique Détectée</strong><br>
            <small>Patient KONÉ Marie - Pénicilline - Il y a 15 min</small>
          </div>
        </div>

        <div class="alert-critical">
          <i class="bi bi-capsule fs-3 text-warning"></i>
          <div class="flex-grow-1">
            <strong>Interaction Médicamenteuse Possible</strong><br>
            <small>Patient TRAORÉ Ibrahim - Warfarine + Aspirine</small>
          </div>
        </div>

        <div class="alert-critical" style="background: #d1ecf1; border-left-color: #17a2b8;">
          <i class="bi bi-file-earmark-medical fs-3 text-info"></i>
          <div class="flex-grow-1">
            <strong>Résultat d'Examen Disponible</strong><br>
            <small>Patient KOUASSI Jean - Bilan sanguin</small>
          </div>
        </div>
      </div>

            <!-- ====== SECTION: DOSSIERS PATIENTS ====== -->
      <div id="section-patients" class="page-section">
        <h3 class="mb-4">Dossiers Patients</h3>

        <div class="section-card">
          <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-primary" onclick="openCreatePatient()">
              <i class="bi bi-person-plus me-2"></i>Creer un patient
            </button>
          </div>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="searchCMU" placeholder="Rechercher par CMU, telephone, nom...">
            <button class="btn btn-primary" onclick="searchPatient()">
              <i class="bi bi-search"></i> Rechercher
            </button>
          </div>
        </div>

        <div class="section-card">
          <h4>Patients Recents</h4>
          <div id="patientsRecentList"></div>
        </div>
      </div>

      <!-- ====== SECTION: PARAMETRES ====== -->
      <div id="section-parametres" class="page-section">
        <h3 class="mb-4">Paramètres</h3>

        <div class="section-card">
          <h4><i class="bi bi-building"></i> Centre de Santé</h4>
          <p><strong>CHU de Cocody</strong></p>
          <p class="text-muted mb-0">Service de Cardiologie</p>
        </div>

        <div class="section-card">
          <h4><i class="bi bi-globe"></i> Langue</h4>
          <select class="form-select">
            <option selected>Français</option>
            <option>English</option>
          </select>
        </div>

        <div class="section-card">
          <h4><i class="bi bi-wifi-off"></i> Mode Offline</h4>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="switchOffline" checked>
            <label class="form-check-label" for="switchOffline">
              Activer le mode hors ligne (enregistrement local des consultations)
            </label>
          </div>
          <p class="text-muted mt-2 mb-0">
            <small>Dernière synchronisation : Aujourd'hui à 14:30</small>
          </p>
        </div>

        <div class="section-card">
          <h4><i class="bi bi-shield-lock"></i> Sécurité</h4>
          <button class="btn btn-outline-danger">
            Déconnecter tous les appareils
          </button>
        </div>
      </div>

    </main>

    <!-- ======= Status Bar =======-->
    <div class="status-bar">
      <div class="d-flex align-items-center me-4">
        <span id="statusIndicator" class="status-indicator online"></span>
        <span id="statusText">En ligne</span>
      </div>
      <div class="me-4">
        <i class="bi bi-geo-alt me-1"></i>
        CHU de Cocody
      </div>
      <div class="ms-auto">
        <i class="bi bi-clock me-1"></i>
        <span id="currentTime">--:--:--</span>
      </div>
    </div>

    <!-- ======= Scanner Modal =======-->
    <div id="scannerModal" class="qr-scanner-modal">
      <div class="qr-scanner-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">Scanner un Patient</h4>
          <button class="btn btn-link" onclick="closeScanner()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <div class="text-center mb-4">
          <i class="bi bi-qr-code-scan" style="font-size: 100px; color: var(--bs-primary);"></i>
          <p class="mt-3">Placez le QR Code ou la carte NFC du patient</p>
        </div>

        <div class="d-grid gap-2">
          <button class="btn btn-primary" onclick="simulateScan()">
            <i class="bi bi-qr-code me-2"></i>
            Simuler un Scan (Test)
          </button>
          <button class="btn btn-outline-primary">
            <i class="bi bi-credit-card me-2"></i>
            Activer NFC
          </button>
          <button class="btn btn-outline-secondary" onclick="closeScanner()">
            Annuler
          </button>
        </div>
      </div>
    </div>

    <!-- ======= Modal Modification Patient =======-->
    <div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editPatientModalLabel">
              <i class="bi bi-pencil-square me-2 text-primary"></i>Modifier le dossier patient
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editPatientId">

            <h6 class="text-primary mb-3">Informations personnelles</h6>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Prénom <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editFirstName">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Nom <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="editLastName">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Téléphone OTP <span class="text-danger">*</span></label>
                <input type="tel" class="form-control" id="editPhone">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">CMU</label>
                <input type="text" class="form-control" id="editCmu" maxlength="10" placeholder="10 chiffres">
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Date de naissance</label>
                <input type="date" class="form-control" id="editDob">
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Sexe</label>
                <select class="form-select" id="editSex">
                  <option value="">-- Choisir --</option>
                  <option value="M">Masculin</option>
                  <option value="F">Féminin</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-semibold">Groupe sanguin</label>
                <select class="form-select" id="editBloodGroup">
                  <option value="">-- Choisir --</option>
                  <option value="A+">A+</option><option value="A-">A-</option>
                  <option value="B+">B+</option><option value="B-">B-</option>
                  <option value="AB+">AB+</option><option value="AB-">AB-</option>
                  <option value="O+">O+</option><option value="O-">O-</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Adresse</label>
                <input type="text" class="form-control" id="editAddress" placeholder="Quartier / Ville">
              </div>
            </div>

            <h6 class="text-primary mb-3">Contact d'urgence</h6>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label fw-semibold">Nom du contact</label>
                <input type="text" class="form-control" id="editEmergencyName">
              </div>
              <div class="col-md-6">
                <label class="form-label fw-semibold">Téléphone du contact</label>
                <input type="tel" class="form-control" id="editEmergencyPhone">
              </div>
            </div>

            <h6 class="text-primary mb-3">Informations médicales</h6>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold">Allergies <small class="text-muted">(séparées par virgule)</small></label>
                <input type="text" class="form-control" id="editAllergies" placeholder="Ex: Pénicilline, Aspirine">
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Maladies chroniques</label>
                <input type="text" class="form-control" id="editChronicDiseases" placeholder="Ex: Diabète type 2, HTA">
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Notes</label>
                <textarea class="form-control" id="editNotes" rows="2" placeholder="Observations particulières..."></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="saveEditPatient()">
              <i class="bi bi-check-lg me-1"></i>Enregistrer les modifications
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======= Javascripts =======-->
    <script src="assets/vendors/bootstrap/bootstrap.bundle.min.js"></script>
  </body>
</html>
